#!/usr/bin/env bash
# clawdspace - CLI for Clawdspace API (Multi-Server with Auto-Discovery)

set -e

# Configuration
CONFIG_FILE="$HOME/.clawdspace"
CACHE_FILE="$HOME/.clawdspace-servers"
CACHE_TTL=300  # 5 minutes

API_KEY="${CLAWDSPACE_KEY:-clawdspace_sk_live_7f8a9b2c3d4e5f6g}"
DEFAULT_PORT=7777

# Known hosts to probe (add your Tailscale IPs/hostnames here)
KNOWN_HOSTS="${CLAWDSPACE_HOSTS:-100.67.131.19 100.64.248.29 oracle wsl rtx3090}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

if [ -f "$CONFIG_FILE" ]; then
  source "$CONFIG_FILE"
fi

usage() {
  echo "clawdspace - Multi-server sandboxed execution environments"
  echo ""
  echo "Usage:"
  echo "  clawdspace create <name> [--server <server>] [--template <name>] [--memory 2g] [--cpus 1] [--repo <url>] [--branch <branch>] [--dest <folder>] [--github-token <token>] [--github-token-stdin]"
  echo "  clawdspace list [--server <server>]"
  echo "  clawdspace exec <name> <command>"
  echo "  clawdspace stop <name>"
  echo "  clawdspace start <name>"
  echo "  clawdspace destroy <name> [-f]"
  echo "  clawdspace servers [--refresh]      # List/discover servers"
  echo "  clawdspace system [--server <server>]"
  echo "  clawdspace config"
  echo ""
  echo "Servers are auto-discovered from known hosts."
  echo "Set CLAWDSPACE_HOSTS in ~/.clawdspace to add more."
}

# Discover Clawdspace servers by probing known hosts
discover_servers() {
  local refresh="$1"
  
  # Check cache
  if [ -z "$refresh" ] && [ -f "$CACHE_FILE" ]; then
    # Linux: stat -c %Y. macOS: stat -f %m.
    local cache_mtime=$(stat -c %Y "$CACHE_FILE" 2>/dev/null || stat -f %m "$CACHE_FILE" 2>/dev/null || echo 0)
    local cache_age=$(($(date +%s) - cache_mtime))
    if [ "$cache_age" -lt "$CACHE_TTL" ]; then
      cat "$CACHE_FILE"
      return
    fi
  fi
  
  local servers=""
  
  # Probe known hosts
  for host in $KNOWN_HOSTS; do
    # Try the host as-is
    local url="http://$host:$DEFAULT_PORT"
    local result=$(curl -s --connect-timeout 0.5 "$url/api/health" 2>/dev/null)
    
    if echo "$result" | grep -q '"ok"'; then
      # Get hostname from system endpoint
      local sys=$(curl -s --connect-timeout 1 "$url/api/system" -H "Authorization: Bearer $API_KEY" 2>/dev/null)
      local name=$(echo "$sys" | python3 -c "import sys,json; print(json.load(sys.stdin).get('hostname','$host'))" 2>/dev/null || echo "$host")
      name=$(echo "$name" | tr '[:upper:]' '[:lower:]')
      servers="$servers $name=$url"
    fi
  done
  
  # Cache results
  echo "$servers" | tr ' ' '\n' | grep '=' | sort -u | tr '\n' ' ' > "$CACHE_FILE"
  cat "$CACHE_FILE"
}

# Get all known servers
get_servers() {
  discover_servers "$1"
}

# Get server URL by name
get_server_url() {
  local name="$1"
  local servers=$(get_servers)

  # Allow passing a full URL as the server.
  if echo "$name" | grep -q '^https\?://'; then
    echo "$name"
    return 0
  fi

  for entry in $servers; do
    local srv_name="${entry%%=*}"
    local srv_url="${entry#*=}"
    if [ "$srv_name" = "$name" ]; then
      echo "$srv_url"
      return 0
    fi
  done

  # Fallback: allow passing a raw hostname from KNOWN_HOSTS.
  for host in $KNOWN_HOSTS; do
    if [ "$host" = "$name" ]; then
      echo "http://$host:$DEFAULT_PORT"
      return 0
    fi
  done

  return 1
}

# List all server names
get_server_names() {
  local servers=$(get_servers)
  for entry in $servers; do
    [ -n "$entry" ] && echo "${entry%%=*}"
  done
}

# Get first available server
get_default_server() {
  get_server_names | head -1
}

# API call to specific server
api() {
  local server="$1"
  local method="$2"
  local path="$3"
  local data="$4"
  local url=$(get_server_url "$server")
  
  if [ -z "$url" ]; then
    echo -e "${RED}Unknown server: $server${NC}" >&2
    return 1
  fi
  
  if [ -n "$data" ]; then
    curl -s -X "$method" "$url/api$path" \
      -H "Authorization: Bearer $API_KEY" \
      -H "Content-Type: application/json" \
      -d "$data" 2>/dev/null
  else
    curl -s -X "$method" "$url/api$path" \
      -H "Authorization: Bearer $API_KEY" 2>/dev/null
  fi
}

# Find which server has a space
find_space() {
  local name="$1"
  for srv in $(get_server_names); do
    result=$(api "$srv" GET "/spaces/$name" 2>/dev/null)
    if echo "$result" | grep -q '"name"'; then
      echo "$srv"
      return 0
    fi
  done
  return 1
}

# Find server with GPU
find_gpu_server() {
  for srv in $(get_server_names); do
    local url=$(get_server_url "$srv")
    local caps=$(curl -s --connect-timeout 2 "$url/api/system/capabilities" -H "Authorization: Bearer $API_KEY" 2>/dev/null)
    if echo "$caps" | grep -q '"gpu":true'; then
      echo "$srv"
      return 0
    fi
  done
  return 1
}

cmd_create() {
  local name=""
  local server=""
  local template_name=""
  local memory="2g"
  local cpus="1"
  local need_gpu=false
  local memory_set=false
  local cpus_set=false
  local gpu_set=false
  local repo_url=""
  local repo_branch=""
  local repo_dest=""
  local github_token=""
  local github_token_stdin=false
  
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --server|-s) server="$2"; shift 2 ;;
      --template|-t) template_name="$2"; shift 2 ;;
      --memory|-m) memory="$2"; memory_set=true; shift 2 ;;
      --cpus|-c) cpus="$2"; cpus_set=true; shift 2 ;;
      --gpu|-g) need_gpu=true; gpu_set=true; shift ;;
      --repo) repo_url="$2"; shift 2 ;;
      --branch) repo_branch="$2"; shift 2 ;;
      --dest) repo_dest="$2"; shift 2 ;;
      --github-token) github_token="$2"; shift 2 ;;
      --github-token-stdin) github_token_stdin=true; shift ;;
      *) if [ -z "$name" ]; then name="$1"; fi; shift ;;
    esac
  done

  if [ "$github_token_stdin" = true ]; then
    if [ -n "$github_token" ]; then
      echo -e "${RED}Error: provide either --github-token or --github-token-stdin, not both${NC}"
      exit 1
    fi

    if [ -t 0 ]; then
      echo -e "${RED}Error: --github-token-stdin requires token on stdin${NC}"
      exit 1
    fi

    github_token=$(cat -)
    github_token=$(echo -n "$github_token" | tr -d '\r\n')
  fi
  
  if [ -z "$name" ]; then
    echo -e "${RED}Error: name required${NC}"
    exit 1
  fi
  
  # Auto-select server based on requirements
  if [ -z "$server" ]; then
    if [ "$need_gpu" = true ]; then
      echo -e "${BLUE}Looking for server with GPU...${NC}"
      server=$(find_gpu_server)
      if [ -z "$server" ]; then
        echo -e "${RED}Error: No server with GPU found${NC}"
        exit 1
      fi
      echo -e "${GREEN}Found GPU server: $server${NC}"
    else
      server=$(get_default_server)
    fi
    
    if [ -z "$server" ]; then
      echo -e "${RED}Error: No Clawdspace servers found. Run 'clawdspace servers --refresh'${NC}"
      exit 1
    fi
  fi
  
  echo -e "${BLUE}Creating space '$name' on $server...${NC}"

  local gpu_json="false"
  if [ "$need_gpu" = true ]; then
    gpu_json="true"
  fi

  # If using a template, don't send explicit memory/cpu/gpu unless user set them.
  local payload="{\"name\":\"$name\""
  if [ "$memory_set" = true ]; then payload+=" ,\"memory\":\"$memory\""; fi
  if [ "$cpus_set" = true ]; then payload+=" ,\"cpus\":$cpus"; fi
  if [ "$gpu_set" = true ]; then payload+=" ,\"gpu\":$gpu_json"; fi

  if [ -n "$template_name" ]; then
    payload+=" ,\"template\":\"$template_name\""
  else
    payload+=" ,\"memory\":\"$memory\" ,\"cpus\":$cpus ,\"gpu\":$gpu_json"
  fi
  if [ -n "$repo_url" ]; then
    payload+=" ,\"repoUrl\":\"$repo_url\""
    if [ -n "$repo_branch" ]; then payload+=" ,\"repoBranch\":\"$repo_branch\""; fi
    if [ -n "$repo_dest" ]; then payload+=" ,\"repoDest\":\"$repo_dest\""; fi
  fi
  if [ -n "$github_token" ]; then
    # NOTE: keep this out of logs; we only send it to the API.
    # Minimal JSON escaping for quotes and backslashes.
    local gh_escaped=${github_token//\\/\\\\}
    gh_escaped=${gh_escaped//\"/\\\"}
    payload+=" ,\"env\":{\"GITHUB_TOKEN\":\"$gh_escaped\"}"
  fi
  payload+="}"

  result=$(api "$server" POST /spaces "$payload")
  
  if echo "$result" | grep -q '"error"'; then
    error=$(echo "$result" | python3 -c "import sys,json; print(json.load(sys.stdin).get('error','Unknown'))" 2>/dev/null)
    echo -e "${RED}Error: $error${NC}"
    exit 1
  fi
  
  echo -e "${GREEN}âœ“ Created space: $name${NC}"
  echo "  Server: $server"
  echo "  Memory: $memory"
  echo "  CPUs: $cpus"
}

cmd_list() {
  local server=""
  
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --server|-s) server="$2"; shift 2 ;;
      *) shift ;;
    esac
  done
  
  echo -e "${BLUE}Spaces:${NC}"
  echo ""
  printf "%-20s %-12s %-12s %-15s\n" "NAME" "SERVER" "STATUS" "RESOURCES"
  printf "%-20s %-12s %-12s %-15s\n" "----" "------" "------" "---------"
  
  local total=0
  for srv in $(get_server_names); do
    if [ -n "$server" ] && [ "$srv" != "$server" ]; then continue; fi
    
    result=$(api "$srv" GET /spaces 2>/dev/null)
    if [ -z "$result" ] || echo "$result" | grep -q '"error"'; then
      continue
    fi
    
    echo "$result" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    for s in data.get('spaces', []):
        mem = s.get('memory', 0) / (1024**3)
        print(f\"{s['name']:<20} $srv{'':>6} {s['status']:<12} {s['cpus']}cpu, {mem:.1f}GB\")
except: pass
" 2>/dev/null
    
    count=$(echo "$result" | python3 -c "import sys,json; print(len(json.load(sys.stdin).get('spaces',[])))" 2>/dev/null || echo 0)
    total=$((total + count))
  done
  
  if [ "$total" -eq 0 ]; then
    echo "  No spaces found."
  fi
}

cmd_exec() {
  local name="$1"
  shift || true
  local command="$*"
  
  if [ -z "$name" ] || [ -z "$command" ]; then
    echo -e "${RED}Error: name and command required${NC}"
    exit 1
  fi
  
  server=$(find_space "$name")
  if [ -z "$server" ]; then
    echo -e "${RED}Error: Space '$name' not found on any server${NC}"
    exit 1
  fi
  
  escaped_command=$(echo "$command" | sed 's/\\/\\\\/g; s/"/\\"/g')
  result=$(api "$server" POST "/spaces/$name/exec" "{\"command\":\"$escaped_command\"}")
  
  if echo "$result" | grep -q '"error"'; then
    error=$(echo "$result" | python3 -c "import sys,json; print(json.load(sys.stdin).get('error','Unknown'))" 2>/dev/null)
    echo -e "${RED}Error: $error${NC}"
    exit 1
  fi
  
  echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if data.get('stdout'): print(data['stdout'])
if data.get('stderr'): print(data['stderr'], file=sys.stderr)
sys.exit(data.get('exitCode', 0))
" 2>/dev/null
}

cmd_stop() {
  local name="$1"
  if [ -z "$name" ]; then echo -e "${RED}Error: name required${NC}"; exit 1; fi
  
  server=$(find_space "$name")
  if [ -z "$server" ]; then echo -e "${RED}Error: Space '$name' not found${NC}"; exit 1; fi
  
  api "$server" POST "/spaces/$name/stop" > /dev/null
  echo -e "${GREEN}âœ“ Paused: $name (on $server)${NC}"
}

cmd_start() {
  local name="$1"
  if [ -z "$name" ]; then echo -e "${RED}Error: name required${NC}"; exit 1; fi
  
  server=$(find_space "$name")
  if [ -z "$server" ]; then echo -e "${RED}Error: Space '$name' not found${NC}"; exit 1; fi
  
  api "$server" POST "/spaces/$name/start" > /dev/null
  echo -e "${GREEN}âœ“ Started: $name (on $server)${NC}"
}

cmd_destroy() {
  local name="$1"
  local force="$2"
  
  if [ -z "$name" ]; then echo -e "${RED}Error: name required${NC}"; exit 1; fi
  
  server=$(find_space "$name")
  if [ -z "$server" ]; then echo -e "${RED}Error: Space '$name' not found${NC}"; exit 1; fi
  
  if [ "$force" != "-f" ] && [ "$force" != "--force" ]; then
    echo -n "Destroy space '$name' on $server? [y/N] "
    read -r confirm
    if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
      echo "Cancelled."
      exit 0
    fi
  fi
  
  api "$server" DELETE "/spaces/$name" > /dev/null
  echo -e "${GREEN}âœ“ Destroyed: $name (was on $server)${NC}"
}

cmd_servers() {
  local refresh=""
  
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --refresh|-r) refresh="1"; shift ;;
      *) shift ;;
    esac
  done
  
  if [ -n "$refresh" ]; then
    echo -e "${BLUE}Scanning known hosts...${NC}"
    rm -f "$CACHE_FILE"
  fi
  
  echo -e "${BLUE}Clawdspace Servers:${NC}"
  echo ""
  printf "%-12s %-25s %-8s %-22s %-15s\n" "NAME" "URL" "STATUS" "RESOURCES" "CAPABILITIES"
  printf "%-12s %-25s %-8s %-22s %-15s\n" "----" "---" "------" "---------" "------------"
  
  local found=0
  for entry in $(get_servers "$refresh"); do
    [ -z "$entry" ] && continue
    local server="${entry%%=*}"
    local url="${entry#*=}"
    
    result=$(curl -s --connect-timeout 2 "$url/api/system" -H "Authorization: Bearer $API_KEY" 2>/dev/null)
    
    if [ -z "$result" ] || echo "$result" | grep -q '"error"'; then
      printf "%-12s %-25s ${RED}%-8s${NC}\n" "$server" "$url" "offline"
    else
      info=$(echo "$result" | python3 -c "
import sys, json
d = json.load(sys.stdin)
caps = d.get('capabilities', {})
gpu_str = ''
if caps.get('gpu'):
    gpu_name = caps.get('gpuName', 'GPU')
    # Shorten GPU name
    if 'RTX' in gpu_name:
        gpu_str = 'ðŸŽ® ' + gpu_name.split('RTX')[1].strip().split()[0]
    else:
        gpu_str = 'ðŸŽ® GPU'
arch = d.get('arch', '?')
print(f\"{d['cpus']}cpu, {d['memory']['percentage']}, {arch}|{gpu_str}\")
" 2>/dev/null || echo "?|")
      resources="${info%|*}"
      gpu="${info#*|}"
      printf "%-12s %-25s ${GREEN}%-8s${NC} %-22s %-15s\n" "$server" "$url" "online" "$resources" "$gpu"
      found=$((found + 1))
    fi
  done
  
  if [ "$found" -eq 0 ]; then
    echo ""
    echo -e "${YELLOW}No Clawdspace servers found.${NC}"
    echo -e "Add hosts to CLAWDSPACE_HOSTS in ~/.clawdspace"
  fi
  
  echo ""
  echo -e "${CYAN}Tip: Use --gpu flag to auto-select a GPU server${NC}"
}

cmd_system() {
  local server=""
  
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --server|-s) server="$2"; shift 2 ;;
      *) shift ;;
    esac
  done
  
  if [ -z "$server" ]; then
    server=$(get_default_server)
  fi
  
  if [ -z "$server" ]; then
    echo -e "${RED}Error: No servers found${NC}"
    exit 1
  fi
  
  result=$(api "$server" GET /system)
  
  if [ -z "$result" ] || echo "$result" | grep -q '"error"'; then
    echo -e "${RED}Error: Could not connect to $server${NC}"
    exit 1
  fi
  
  echo -e "${BLUE}System Status ($server):${NC}"
  echo ""
  echo "$result" | python3 -c "
import sys, json
d = json.load(sys.stdin)
print(f\"  Hostname:   {d['hostname']}\")
print(f\"  Platform:   {d['platform']} ({d['arch']})\")
print(f\"  CPUs:       {d['cpus']}\")
print(f\"  Load:       {d['loadAverage'][0]:.2f}\")
print(f\"  Memory:     {d['memory']['percentage']} ({d['memory']['used']} / {d['memory']['total']})\")
if d.get('disk'):
    print(f\"  Disk:       {d['disk']['percentage']} ({d['disk']['used']} / {d['disk']['total']})\")
print(f\"  Uptime:     {d['uptime']}\")
print(f\"  Containers: {d['docker']['containersRunning']} running\")
" 2>/dev/null
}

cmd_config() {
  echo "Config file:  $CONFIG_FILE"
  echo "Cache file:   $CACHE_FILE"
  echo "Known hosts:  $KNOWN_HOSTS"
  echo ""
  echo "API Key: ${API_KEY:0:30}..."
  echo ""
  echo "Discovered servers:"
  for entry in $(get_servers); do
    [ -z "$entry" ] && continue
    local server="${entry%%=*}"
    local url="${entry#*=}"
    echo "  $server: $url"
  done
}

# Main
case "${1:-}" in
  create)   shift; cmd_create "$@" ;;
  list|ls)  shift; cmd_list "$@" ;;
  exec|x)   shift; cmd_exec "$@" ;;
  stop)     shift; cmd_stop "$@" ;;
  start)    shift; cmd_start "$@" ;;
  destroy)  shift; cmd_destroy "$@" ;;
  servers)  shift; cmd_servers "$@" ;;
  system)   shift; cmd_system "$@" ;;
  config)   cmd_config ;;
  *)        usage ;;
esac
