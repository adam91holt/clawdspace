#!/bin/bash
# clawdspace - CLI for Clawdspace API

set -e

# Configuration
CONFIG_FILE="$HOME/.clawdspace"
if [ -f "$CONFIG_FILE" ]; then
  source "$CONFIG_FILE"
fi

API_URL="${CLAWDSPACE_URL:-http://oracle:7777}"
API_KEY="${CLAWDSPACE_KEY:-clawdspace_sk_live_7f8a9b2c3d4e5f6g}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

usage() {
  echo "clawdspace - Self-hosted sandboxed execution environments"
  echo ""
  echo "Usage:"
  echo "  clawdspace create <name> [--memory 2g] [--cpus 1]"
  echo "  clawdspace list"
  echo "  clawdspace exec <name> <command>"
  echo "  clawdspace stop <name>"
  echo "  clawdspace start <name>"
  echo "  clawdspace destroy <name>"
  echo "  clawdspace status <name>"
  echo "  clawdspace system"
  echo "  clawdspace dashboard"
  echo "  clawdspace config <url> <key>"
  echo ""
  echo "Examples:"
  echo "  clawdspace create dev"
  echo "  clawdspace exec dev 'python3 --version'"
  echo "  clawdspace stop dev"
  echo ""
  echo "Config file: $CONFIG_FILE"
}

api() {
  local method="$1"
  local path="$2"
  local data="$3"
  
  if [ -n "$data" ]; then
    curl -s -X "$method" "$API_URL/api$path" \
      -H "Authorization: Bearer $API_KEY" \
      -H "Content-Type: application/json" \
      -d "$data"
  else
    curl -s -X "$method" "$API_URL/api$path" \
      -H "Authorization: Bearer $API_KEY"
  fi
}

cmd_create() {
  local name="$1"
  local memory="2g"
  local cpus="1"
  
  shift || true
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --memory) memory="$2"; shift 2 ;;
      --cpus) cpus="$2"; shift 2 ;;
      *) shift ;;
    esac
  done
  
  if [ -z "$name" ]; then
    echo -e "${RED}Error: name required${NC}"
    exit 1
  fi
  
  echo -e "${BLUE}Creating space: $name${NC}"
  result=$(api POST /spaces "{\"name\":\"$name\",\"memory\":\"$memory\",\"cpus\":$cpus}")
  
  if echo "$result" | grep -q '"error"'; then
    echo -e "${RED}Error: $(echo "$result" | grep -o '"error":"[^"]*"' | cut -d'"' -f4)${NC}"
    exit 1
  fi
  
  echo -e "${GREEN}✓ Created space: $name${NC}"
  echo "  Memory: $memory"
  echo "  CPUs: $cpus"
  echo ""
  echo "Run commands with: clawdspace exec $name <command>"
}

cmd_list() {
  result=$(api GET /spaces)
  
  echo -e "${BLUE}Spaces:${NC}"
  echo ""
  
  if echo "$result" | grep -q '"spaces":\[\]'; then
    echo "  No spaces yet. Create one with: clawdspace create <name>"
    return
  fi
  
  printf "%-20s %-12s %-15s\n" "NAME" "STATUS" "RESOURCES"
  printf "%-20s %-12s %-15s\n" "----" "------" "---------"
  
  # Parse with python for reliability
  echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
for s in data.get('spaces', []):
    mem = s.get('memory', 0) / (1024**3)
    print(f\"{s['name']:<20} {s['status']:<12} {s['cpus']}cpu, {mem:.1f}GB\")
" 2>/dev/null || echo "$result"
}

cmd_exec() {
  local name="$1"
  shift || true
  local command="$*"
  
  if [ -z "$name" ] || [ -z "$command" ]; then
    echo -e "${RED}Error: name and command required${NC}"
    echo "Usage: clawdspace exec <name> <command>"
    exit 1
  fi
  
  # Escape the command for JSON
  escaped_command=$(echo "$command" | sed 's/\\/\\\\/g; s/"/\\"/g')
  
  result=$(api POST "/spaces/$name/exec" "{\"command\":\"$escaped_command\"}")
  
  if echo "$result" | grep -q '"error"'; then
    error=$(echo "$result" | python3 -c "import sys,json; print(json.load(sys.stdin).get('error','Unknown error'))" 2>/dev/null || echo "Unknown error")
    echo -e "${RED}Error: $error${NC}"
    exit 1
  fi
  
  # Parse output with python
  echo "$result" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if data.get('stdout'):
    print(data['stdout'])
if data.get('stderr'):
    import os
    print(data['stderr'], file=sys.stderr)
sys.exit(data.get('exitCode', 0))
" 2>/dev/null
  exit $?
}

cmd_stop() {
  local name="$1"
  if [ -z "$name" ]; then
    echo -e "${RED}Error: name required${NC}"
    exit 1
  fi
  
  result=$(api POST "/spaces/$name/stop")
  
  if echo "$result" | grep -q '"error"'; then
    echo -e "${RED}Error: $(echo "$result" | grep -o '"error":"[^"]*"' | cut -d'"' -f4)${NC}"
    exit 1
  fi
  
  echo -e "${GREEN}✓ Paused: $name${NC}"
}

cmd_start() {
  local name="$1"
  if [ -z "$name" ]; then
    echo -e "${RED}Error: name required${NC}"
    exit 1
  fi
  
  result=$(api POST "/spaces/$name/start")
  
  if echo "$result" | grep -q '"error"'; then
    echo -e "${RED}Error: $(echo "$result" | grep -o '"error":"[^"]*"' | cut -d'"' -f4)${NC}"
    exit 1
  fi
  
  echo -e "${GREEN}✓ Started: $name${NC}"
}

cmd_destroy() {
  local name="$1"
  local force="$2"
  
  if [ -z "$name" ]; then
    echo -e "${RED}Error: name required${NC}"
    exit 1
  fi
  
  if [ "$force" != "-f" ] && [ "$force" != "--force" ]; then
    echo -n "Destroy space '$name'? [y/N] "
    read -r confirm
    if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
      echo "Cancelled."
      exit 0
    fi
  fi
  
  result=$(api DELETE "/spaces/$name")
  
  if echo "$result" | grep -q '"error"'; then
    echo -e "${RED}Error: $(echo "$result" | grep -o '"error":"[^"]*"' | cut -d'"' -f4)${NC}"
    exit 1
  fi
  
  echo -e "${GREEN}✓ Destroyed: $name${NC}"
}

cmd_status() {
  local name="$1"
  if [ -z "$name" ]; then
    echo -e "${RED}Error: name required${NC}"
    exit 1
  fi
  
  result=$(api GET "/spaces/$name")
  
  if echo "$result" | grep -q '"error"'; then
    echo -e "${RED}Error: Space not found${NC}"
    exit 1
  fi
  
  echo "$result" | python3 -m json.tool 2>/dev/null || echo "$result"
}

cmd_system() {
  result=$(api GET /system)
  
  echo -e "${BLUE}System Status:${NC}"
  echo ""
  
  echo "$result" | python3 -c "
import sys, json
d = json.load(sys.stdin)
print(f\"  Hostname:   {d['hostname']}\")
print(f\"  Platform:   {d['platform']} ({d['arch']})\")
print(f\"  CPUs:       {d['cpus']}\")
print(f\"  Load:       {d['loadAverage'][0]:.2f}, {d['loadAverage'][1]:.2f}, {d['loadAverage'][2]:.2f}\")
print(f\"  Memory:     {d['memory']['percentage']} used ({d['memory']['used']} / {d['memory']['total']})\")
if d.get('disk'):
    print(f\"  Disk:       {d['disk']['percentage']} used ({d['disk']['used']} / {d['disk']['total']})\")
print(f\"  Uptime:     {d['uptime']}\")
print(f\"  Docker:     v{d['docker']['version']}\")
print(f\"  Containers: {d['docker']['containersRunning']} running, {d['docker']['containersPaused']} paused\")
" 2>/dev/null || echo "$result"
}

cmd_dashboard() {
  echo -e "${BLUE}Opening dashboard...${NC}"
  open "$API_URL" 2>/dev/null || xdg-open "$API_URL" 2>/dev/null || echo "Dashboard: $API_URL"
}

cmd_config() {
  local url="$1"
  local key="$2"
  
  if [ -z "$url" ] || [ -z "$key" ]; then
    echo "Current config:"
    echo "  URL: $API_URL"
    echo "  Key: ${API_KEY:0:30}..."
    echo ""
    echo "To update: clawdspace config <url> <key>"
    return
  fi
  
  echo "CLAWDSPACE_URL=\"$url\"" > "$CONFIG_FILE"
  echo "CLAWDSPACE_KEY=\"$key\"" >> "$CONFIG_FILE"
  chmod 600 "$CONFIG_FILE"
  
  echo -e "${GREEN}✓ Config saved to $CONFIG_FILE${NC}"
}

# Main
case "${1:-}" in
  create)  shift; cmd_create "$@" ;;
  list|ls) cmd_list ;;
  exec|x)  shift; cmd_exec "$@" ;;
  stop)    shift; cmd_stop "$@" ;;
  start)   shift; cmd_start "$@" ;;
  destroy) shift; cmd_destroy "$@" ;;
  status)  shift; cmd_status "$@" ;;
  system)  cmd_system ;;
  dashboard) cmd_dashboard ;;
  config)  shift; cmd_config "$@" ;;
  *)       usage ;;
esac
